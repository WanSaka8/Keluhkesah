<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keluh Kesah</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    header {
      background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7);
      background-size: 300% 300%;
      animation: gradientShift 8s ease infinite;
      color: white;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    @keyframes gradientShift {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    header h1 {
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      margin-bottom: 0.5rem;
    }

    header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .stats {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    .stat-item {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .stat-item:hover {
      transform: scale(1.05);
      background: rgba(255, 255, 255, 0.3);
    }

    /* Weather Widget */
    .weather-widget {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    nav {
      display: flex;
      justify-content: center;
      gap: 0.8rem;
      margin: 1.5rem 0;
      padding: 0 1rem;
      flex-wrap: nowrap;
    }

    nav button {
      flex: 1;
      padding: 1rem 0.5rem;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      text-align: center;
    }

    nav button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      background: rgba(255, 255, 255, 0.3);
    }

    nav button.active {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .page {
      display: none;
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
    }

    .page.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-row {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .input-group {
      position: relative;
      flex: 1;
    }

    input,
    textarea,
    select {
      padding: 1rem;
      border-radius: 15px;
      border: 2px solid #e1e8ed;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
      width: 100%;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #4ecdc4;
      box-shadow: 0 0 20px rgba(78, 205, 196, 0.2);
      transform: translateY(-2px);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .mood-selector {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .mood-option {
      padding: 0.5rem 1rem;
      border: 2px solid #e1e8ed;
      border-radius: 25px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .mood-option:hover {
      transform: scale(1.05);
    }

    .mood-option.selected {
      border-color: #4ecdc4;
      background: #4ecdc4;
      color: white;
    }

    /* Category Selector */
    .category-selector {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .category-option {
      padding: 0.4rem 0.8rem;
      border: 2px solid #e1e8ed;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }

    .category-option:hover {
      transform: scale(1.05);
    }

    .category-option.selected {
      border-color: #ff6b6b;
      background: #ff6b6b;
      color: white;
    }

    /* Voice Recording */
    .voice-recorder {
      display: flex;
      gap: 1rem;
      align-items: center;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      margin: 1rem 0;
    }

    .voice-btn {
      padding: 0.8rem;
      border: none;
      border-radius: 50%;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.3s ease;
    }

    .voice-btn:hover {
      transform: scale(1.1);
    }

    .voice-btn.recording {
      animation: pulse 1s infinite;
      background: linear-gradient(45deg, #ff4757, #ff3838);
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

    /* Anonymous Toggle */
    .anonymous-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }

    .switch {
      position: relative;
      width: 50px;
      height: 25px;
      background: #e1e8ed;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .switch.active {
      background: #4ecdc4;
    }

    .switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 21px;
      height: 21px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .switch.active::after {
      left: 27px;
    }

    /* Mood Predictor */
    .mood-predictor {
      background: rgba(255, 255, 255, 0.1);
      padding: 1rem;
      border-radius: 15px;
      margin: 1rem 0;
      text-align: center;
    }

    .predicted-mood {
      font-size: 2rem;
      margin: 0.5rem 0;
    }

    button.submit {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }

    button.submit:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(78, 205, 196, 0.4);
    }

    .search-container {
      margin-bottom: 2rem;
    }

    .search-box {
      background: rgba(255, 255, 255, 0.95);
      padding: 1rem;
      border-radius: 15px;
      display: flex;
      gap: 1rem;
      align-items: center;
      backdrop-filter: blur(10px);
    }

    /* Advanced Filters */
    .filter-section {
      background: rgba(255, 255, 255, 0.95);
      padding: 1rem;
      border-radius: 15px;
      margin-bottom: 1rem;
      backdrop-filter: blur(10px);
    }

    .filter-row {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .filter-group {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.8rem;
      justify-items: center;
    }

    .filter-btn {
      padding: 0.4rem;
      border: 2px solid #e1e8ed;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2rem;
      width: 45px;
      height: 45px;
      text-align: center;
      line-height: 1.2;
    }

    .filter-btn.active {
      border-color: #4ecdc4;
      background: #4ecdc4;
      color: white;
    }

    /* Time Filter */
    .time-filter {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .time-btn {
      padding: 0.4rem 0.8rem;
      border: 2px solid #e1e8ed;
      border-radius: 15px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }

    .time-btn.active {
      border-color: #45b7d1;
      background: #45b7d1;
      color: white;
    }

    ul {
      list-style: none;
      padding: 0;
      display: grid;
      gap: 1rem;
    }

    li {
      background: rgba(255, 255, 255, 0.95);
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    li:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    li::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
      background-size: 300% 300%;
      animation: gradientShift 3s ease infinite;
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .note-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .author-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .author-name {
      font-weight: 700;
      color: #2d3748;
      font-size: 1.1rem;
    }

    .mood-badge {
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .category-badge {
      padding: 0.2rem 0.6rem;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.8);
      color: #666;
      margin-left: 0.5rem;
    }

    .mood-happy {
      background: #fef3c7;
      color: #d97706;
    }

    .mood-sad {
      background: #dbeafe;
      color: #2563eb;
    }

    .mood-angry {
      background: #fecaca;
      color: #dc2626;
    }

    .mood-excited {
      background: #ecfdf5;
      color: #059669;
    }

    .mood-confused {
      background: #f3e8ff;
      color: #7c3aed;
    }

    .mood-grateful {
      background: #fdf2f8;
      color: #db2777;
    }

    .note-text {
      color: #4a5568;
      line-height: 1.6;
      margin-bottom: 1rem;
      word-wrap: break-word;
    }

    /* Comments Section */
    .comments-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e1e8ed;
    }

    .comments-toggle {
      cursor: pointer;
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .comments-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }

    .comment {
      background: rgba(0, 0, 0, 0.05);
      padding: 0.8rem;
      border-radius: 10px;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .comment-form {
      display: flex;
      gap: 0.5rem;
    }

    .comment-input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #e1e8ed;
      border-radius: 10px;
      font-size: 0.9rem;
    }

    .comment-btn {
      padding: 0.5rem 1rem;
      background: #4ecdc4;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .note-footer {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .note-footer-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .timestamp {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      color: #718096;
      font-size: 0.85rem;
      background: rgba(113, 128, 150, 0.1);
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-weight: 500;
    }

    .reactions-section {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .reaction-btn {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.4rem 0.8rem;
      border: 2px solid #e1e8ed;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85rem;
    }

    .reaction-btn:hover {
      transform: scale(1.05);
    }

    .reaction-btn.active {
      border-color: #4ecdc4;
      background: #4ecdc4;
      color: white;
    }

    .actions-section {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .action-btn {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .delete-btn {
      background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
      color: white;
    }

    .edit-btn {
      background: linear-gradient(45deg, #45b7d1, #64b5f6);
      color: white;
    }

    .share-btn {
      background: linear-gradient(45deg, #96ceb4, #81c784);
      color: white;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    /* Mood Map */
    .mood-map {
      background: rgba(255, 255, 255, 0.95);
      padding: 2rem;
      border-radius: 20px;
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
    }

    .mood-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .mood-day {
      aspect-ratio: 1;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mood-day:hover {
      transform: scale(1.1);
    }

    /* Daily Challenge */
    .daily-challenge {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      padding: 1.5rem;
      border-radius: 20px;
      margin-bottom: 2rem;
      text-align: center;
    }

    .challenge-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .challenge-description {
      font-size: 1rem;
      opacity: 0.9;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      background: linear-gradient(45deg, #4ecdc4, #45b7d1);
      color: white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transform: translateX(400px);
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.error {
      background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .character-count {
      text-align: right;
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
    }

    .character-count.warning {
      color: #ff6b6b;
    }

    /* Dark Mode - Much brighter text contrast */
    body.dark-mode {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: #ffffff;
    }

    .dark-mode .form-container,
    .dark-mode .filter-section,
    .dark-mode .mood-map,
    .dark-mode li {
      background: rgba(44, 62, 80, 0.95);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .dark-mode .search-box {
      background: rgba(44, 62, 80, 0.95);
      color: #ffffff;
    }

    .dark-mode input,
    .dark-mode textarea,
    .dark-mode select {
      background: rgba(52, 73, 94, 0.9);
      color: #ffffff;
      border-color: #5a6c7d;
    }

    .dark-mode input::placeholder,
    .dark-mode textarea::placeholder {
      color: #e0e0e0;
    }

    .dark-mode .author-name {
      color: #ffffff;
    }

    .dark-mode .note-text {
      color: #f0f0f0;
    }

    .dark-mode .timestamp {
      color: #e0e0e0;
      background: rgba(255, 255, 255, 0.15);
    }

    .dark-mode .comments-toggle {
      color: #e0e0e0;
    }

    .dark-mode .comment {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }

    /* Fix untuk tanggal komentar di dark mode */
    .dark-mode .comment div[style*="color: #666"] {
      color: #e0e0e0 !important;
    }

    .dark-mode .comment>div {
      color: #e0e0e0 !important;
    }

    .dark-mode .comment-input {
      background: rgba(52, 73, 94, 0.9);
      color: #ffffff;
      border-color: #5a6c7d;
    }

    .dark-mode .modal-content {
      background: #2c3e50;
      color: #ffffff;
    }

    .dark-mode .close-btn {
      color: #e0e0e0;
    }

    .dark-mode .character-count {
      color: #e0e0e0;
    }

    .dark-mode .mood-option,
    .dark-mode .category-option,
    .dark-mode .filter-btn,
    .dark-mode .time-btn,
    .dark-mode .reaction-btn {
      background: rgba(52, 73, 94, 0.9);
      color: #ffffff;
      border-color: #5a6c7d;
    }

    .dark-mode .mood-option:hover,
    .dark-mode .category-option:hover,
    .dark-mode .filter-btn:hover,
    .dark-mode .time-btn:hover,
    .dark-mode .reaction-btn:hover {
      background: rgba(72, 93, 114, 0.9);
    }

    /* Theme Toggle */
    .theme-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 0.8rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      z-index: 999;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
      background: rgba(255, 255, 255, 0.3);
    }

    /* Responsive */
    @media (max-width: 768px) {
      header h1 {
        font-size: 2rem;
      }

      .stats {
        flex-direction: column;
        gap: 0.5rem;
      }

      nav {
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }

      nav button {
        width: 200px;
      }

      .page {
        padding: 1rem;
      }

      .form-row {
        flex-direction: column;
      }

      .filter-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .note-footer {
        flex-direction: column;
        align-items: flex-start;
      }

      /* 🎨 Styling untuk halaman Galeri */
      #page-gallery {
        padding: 2rem;
        background: linear-gradient(135deg, #f9f9f9, #f0fdfd);
        min-height: 100vh;
        border-radius: 16px;
      }

      /* Judul Galeri */
      #page-gallery h2 {
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 1.5rem;
        text-align: center;
      }

      /* Form Upload */
      #uploadForm {
        background: #fff;
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
      }

      #uploadForm input[type="file"],
      #uploadForm input[type="text"] {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 0.5rem;
        font-size: 0.9rem;
        transition: 0.2s ease-in-out;
      }

      #uploadForm input[type="file"]:hover,
      #uploadForm input[type="text"]:focus {
        border-color: #4ecdc4;
        outline: none;
      }

      #uploadForm button {
        background: #4ecdc4;
        color: #fff;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease-in-out, transform 0.1s ease-in-out;
      }

      #uploadForm button:hover {
        background: #38b2ac;
        transform: scale(1.05);
      }

      /* Grid Galeri */
      #galleryGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1.5rem;
      }

      /* Card Gambar */
      .gallery-item {
        background: #fff;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        transition: transform 0.2s ease-in-out;
      }

      .gallery-item:hover {
        transform: translateY(-4px);
      }

      /* Gambar */
      .gallery-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }

      /* Caption */
      .gallery-caption {
        padding: 0.8rem;
        font-size: 0.9rem;
        color: #444;
        border-top: 1px solid #eee;
        background: #fafafa;
      }

      /* Tombol Aksi */
      .gallery-actions {
        display: flex;
        gap: 0.5rem;
        padding: 0.8rem;
        border-top: 1px solid #f0f0f0;
      }

      .gallery-actions button {
        flex: 1;
        padding: 0.5rem;
        font-size: 0.85rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s ease-in-out;
      }

      .gallery-actions button:first-child {
        background: #45b7d1;
        color: white;
      }

      .gallery-actions button:first-child:hover {
        background: #2ca1bb;
      }

      .gallery-actions button:last-child {
        background: #ff6b6b;
        color: white;
      }

      .gallery-actions button:last-child:hover {
        background: #e63946;
      }


      .note-footer-top {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }

      .reactions-section {
        width: 100%;
        justify-content: space-between;
      }

      .weather-widget {
        position: static;
        margin-bottom: 1rem;
      }

      .theme-toggle {
        top: 10px;
        left: 10px;
      }

      /* Mobile mood map improvements */
      .mood-grid {
        gap: 0.3rem;
      }

      .mood-day {
        font-size: 0.9rem;
        min-height: 35px;
      }

      .mood-map {
        padding: 1rem;
      }
    }

    @media (max-width: 767px) {
      nav {
        gap: 0.5rem;
      }

      nav button {
        font-size: 0.8rem;
        padding: 0.8rem 0.3rem;
      }
    }

    @media (max-width: 480px) {
      .mood-grid {
        gap: 0.2rem;
      }

      .mood-day {
        font-size: 0.8rem;
        min-height: 30px;
      }
    }
  </style>
</head>

<body>
  <!-- Theme Toggle -->
  <button class="theme-toggle" onclick="toggleTheme()">🌙</button>

  <header>
    <!-- Weather Widget -->
    <div class="weather-widget" id="weatherWidget">
      <span>🌤️</span>
      <span>Loading...</span>
    </div>

    <h1>💭 Keluh Kesah</h1>
    <p>Tempat berbagi cerita dan keluh kesah</p>
    <div class="stats">
      <div class="stat-item">📝 <span id="totalPosts">0</span> cerita</div>
      <div class="stat-item">❤️ <span id="totalLikes">0</span> likes</div>
      <div class="stat-item">👥 <span id="activeUsers">0</span> kontributor</div>
      <div class="stat-item">🔥 <span id="dailyStreak">0</span> hari berturut</div>
    </div>
  </header>

  <nav>
    <button id="btn-tulis" class="active">✍️ Tulis Cerita</button>
    <button id="btn-daftar">📋 Daftar Cerita</button>
    <button id="btn-trending">🔥 Trending</button>
    <button id="btn-analytics">📊 Analytics</button>
    <button id="btn-mood-map">📅 Mood Map</button>
    <button id="btn-gallery">🖼️ Galeri</button>
  </nav>

  <!-- Daily Challenge -->
  <div class="daily-challenge">
    <div class="challenge-title">🎯 Tantangan Hari Ini</div>
    <div class="challenge-description" id="dailyChallenge">
      Ceritakan satu hal kecil yang membuat kamu tersenyum hari ini!
    </div>
  </div>

  <!-- Halaman Tulis -->
  <div id="page-tulis" class="page">
    <div class="form-container">
      <form id="noteForm">
        <div class="form-row">
          <div class="input-group">
            <input type="text" id="nama" placeholder="Siapa nama kamu?" required>
          </div>
          <div class="anonymous-toggle">
            <span>Anonim</span>
            <div class="switch" id="anonymousSwitch"></div>
          </div>
        </div>

        <div class="input-group">
          <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Kategori:</label>
          <div class="category-selector">
            <div class="category-option" data-category="personal">👤 Personal</div>
            <div class="category-option" data-category="work">💼 Kerja</div>
            <div class="category-option" data-category="family">👨‍👩‍👧‍👦 Keluarga</div>
            <div class="category-option" data-category="love">💕 Cinta</div>
            <div class="category-option" data-category="health">🏥 Kesehatan</div>
            <div class="category-option" data-category="education">🎓 Pendidikan</div>
          </div>
        </div>

        <div class="input-group">
          <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Mood saat ini:</label>
          <div class="mood-selector">
            <div class="mood-option" data-mood="happy">😊 Senang</div>
            <div class="mood-option" data-mood="sad">😢 Sedih</div>
            <div class="mood-option" data-mood="angry">😠 Marah</div>
            <div class="mood-option" data-mood="excited">🤩 Antusias</div>
            <div class="mood-option" data-mood="confused">😕 Bingung</div>
            <div class="mood-option" data-mood="grateful">🙏 Bersyukur</div>
          </div>
        </div>

        <!-- Voice Recorder -->
        <div class="voice-recorder">
          <button type="button" class="voice-btn" id="voiceBtn">🎙️</button>
          <div id="voiceStatus">Klik untuk mulai merekam suara (opsional)</div>
          <div id="voiceTime"></div>
        </div>

        <!-- Mood Predictor -->
        <div class="mood-predictor">
          <div>🤖 AI Mood Predictor</div>
          <div class="predicted-mood" id="predictedMood">🤔</div>
          <div id="moodPrediction">Tulis sesuatu untuk memprediksi mood...</div>
        </div>

        <div class="input-group">
          <textarea id="catatan" placeholder="Ceritakan keluh kesah atau pengalaman kamu di sini..." required
            maxlength="500"></textarea>
          <div class="character-count">
            <span id="charCount">0</span>/500 karakter
          </div>
        </div>

        <button type="submit" class="submit">🚀 Kirim Cerita</button>
      </form>
    </div>
  </div>

  <!-- Halaman Daftar -->
  <div id="page-daftar" class="page">
    <div class="search-container">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="🔍 Cari cerita..."
          style="border: none; background: transparent; flex: 1;">
        <select id="sortSelect" style="border: none; background: transparent;">
          <option value="newest">Terbaru</option>
          <option value="oldest">Terlama</option>
          <option value="popular">Terpopuler</option>
          <option value="random">Random</option>
        </select>
      </div>
    </div>

    <div class="filter-section">
      <div class="filter-row">
        <span style="font-weight: 600;">Filter mood:</span>
        <div class="filter-group">
          <div class="filter-btn active" data-filter="all">✅</div>
          <div class="filter-btn" data-filter="happy">😊</div>
          <div class="filter-btn" data-filter="sad">😢</div>
          <div class="filter-btn" data-filter="angry">😠</div>
          <div class="filter-btn" data-filter="excited">🤩</div>
          <div class="filter-btn" data-filter="confused">😕</div>
          <div class="filter-btn" data-filter="grateful">🙏</div>
        </div>
      </div>

      <div class="filter-row">
        <span style="font-weight: 600;">Filter waktu:</span>
        <div class="time-filter">
          <div class="time-btn active" data-time="all">Semua</div>
          <div class="time-btn" data-time="today">Hari ini</div>
          <div class="time-btn" data-time="week">Minggu ini</div>
          <div class="time-btn" data-time="month">Bulan ini</div>
        </div>
      </div>

      <div class="filter-row">
        <span style="font-weight: 600;">Filter kategori:</span>
        <div class="time-filter">
          <div class="time-btn active" data-category-filter="all">Semua</div>
          <div class="time-btn" data-category-filter="personal">Personal</div>
          <div class="time-btn" data-category-filter="work">Kerja</div>
          <div class="time-btn" data-category-filter="family">Keluarga</div>
          <div class="time-btn" data-category-filter="love">Cinta</div>
          <div class="time-btn" data-category-filter="health">Kesehatan</div>
        </div>
      </div>
    </div>

    <ul id="notesList"></ul>
    <div id="emptyState" class="empty-state" style="display: none;">
      <h3>📝 Belum ada cerita</h3>
      <p>Jadilah yang pertama membagikan keluh kesah atau cerita!</p>
    </div>
  </div>

  <!-- Halaman Trending -->
  <div id="page-trending" class="page">
    <div class="trending-section">
      <div class="trending-title">🔥 Trending Topics</div>
      <div class="trending-tags" id="trendingTags">
        <div class="trending-tag">#keluhkesah</div>
        <div class="trending-tag">#ceritasedih</div>
        <div class="trending-tag">#motivasi</div>
        <div class="trending-tag">#pengalaman</div>
        <div class="trending-tag">#keluarga</div>
        <div class="trending-tag">#kerja</div>
      </div>
    </div>

    <div class="trending-section">
      <div class="trending-title">⭐ Cerita Terpopuler Minggu Ini</div>
      <ul id="popularNotes"></ul>
    </div>

    <div class="trending-section">
      <div class="trending-title">🎯 Word Cloud</div>
      <div id="wordCloud" style="text-align: center; padding: 2rem; font-family: serif;">
        <span style="font-size: 2rem; color: #ff6b6b;">sedih</span>
        <span style="font-size: 1.5rem; color: #4ecdc4;">bahagia</span>
        <span style="font-size: 1.8rem; color: #45b7d1;">kerja</span>
        <span style="font-size: 1.3rem; color: #96ceb4;">keluarga</span>
        <span style="font-size: 2.2rem; color: #ffeaa7;">cinta</span>
        <span style="font-size: 1.6rem; color: #ff7675;">stress</span>
        <span style="font-size: 1.4rem; color: #74b9ff;">motivasi</span>
      </div>
    </div>
  </div>

  <!-- Halaman Analytics -->
  <div id="page-analytics" class="page">
    <div class="trending-section">
      <div class="trending-title">📊 Analytics Dashboard</div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div
          style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold;" id="totalPostsAnalytics">0</div>
          <div>Total Cerita</div>
        </div>
        <div
          style="background: linear-gradient(45deg, #4ecdc4, #45b7d1); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold;" id="totalReactionsAnalytics">0</div>
          <div>Total Reaksi</div>
        </div>
        <div
          style="background: linear-gradient(45deg, #96ceb4, #81c784); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold;" id="avgReactionsAnalytics">0</div>
          <div>Rata-rata Reaksi</div>
        </div>
        <div
          style="background: linear-gradient(45deg, #ffeaa7, #fdcb6e); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold;" id="topMoodAnalytics">😊</div>
          <div>Mood Terpopuler</div>
        </div>
        <div
          style="background: linear-gradient(45deg, #a29bfe, #6c5ce7); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold;" id="activeHoursAnalytics">18:00</div>
          <div>Jam Teraktif</div>
        </div>
        <div
          style="background: linear-gradient(45deg, #fd79a8, #e84393); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold;" id="longestStreakAnalytics">0</div>
          <div>Streak Terpanjang</div>
        </div>
      </div>
    </div>

    <div class="trending-section">
      <div class="trending-title">📈 Mood Distribution</div>
      <div id="moodChart" style="display: flex; gap: 1rem; flex-wrap: wrap;"></div>
    </div>

    <div class="trending-section">
      <div class="trending-title">📅 Aktivitas Harian</div>
      <div id="activityChart"
        style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-top: 1rem;">
        <div style="text-align: center; font-weight: bold; padding: 0.5rem;">Sen</div>
        <div style="text-align: center; font-weight: bold; padding: 0.5rem;">Sel</div>
        <div style="text-align: center; font-weight: bold; padding: 0.5rem;">Rab</div>
        <div style="text-align: center; font-weight: bold; padding: 0.5rem;">Kam</div>
        <div style="text-align: center; font-weight: bold; padding: 0.5rem;">Jum</div>
        <div style="text-align: center; font-weight: bold; padding: 0.5rem;">Sab</div>
        <div style="text-align: center; font-weight: bold; padding: 0.5rem;">Min</div>
      </div>
    </div>
  </div>

  <!-- Halaman Mood Map -->
  <div id="page-mood-map" class="page">
    <div class="mood-map">
      <div class="trending-title">📅 Mood Calendar</div>
      <p style="color: #666; margin-bottom: 1rem;">Klik pada tanggal untuk melihat mood kamu hari itu</p>
      <div id="moodCalendar" class="mood-grid"></div>
    </div>

    <div class="trending-section">
      <div class="trending-title">📊 Mood Statistics</div>
      <div id="moodStats"
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
        <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
          <div style="font-size: 2rem;">😊</div>
          <div style="font-weight: bold; margin: 0.5rem 0;">Mood Dominan</div>
          <div style="color: #666;">Senang</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
          <div style="font-size: 2rem;">📈</div>
          <div style="font-weight: bold; margin: 0.5rem 0;">Trend</div>
          <div style="color: #666;">Naik</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
          <div style="font-size: 2rem;">🔥</div>
          <div style="font-weight: bold; margin: 0.5rem 0;">Konsistensi</div>
          <div style="color: #666;" id="consistencyScore">85%</div>
        </div>
      </div>
    </div>

    <div class="trending-section">
      <div class="trending-title">💡 Mood Insights</div>
      <div id="moodInsights" style="display: flex; flex-direction: column; gap: 1rem;">
        <div
          style="padding: 1rem; background: rgba(78, 205, 196, 0.1); border-left: 4px solid #4ecdc4; border-radius: 0 10px 10px 0;">
          <strong>💡 Insight:</strong> Kamu cenderung lebih bahagia di akhir pekan!
        </div>
        <div
          style="padding: 1rem; background: rgba(255, 107, 107, 0.1); border-left: 4px solid #ff6b6b; border-radius: 0 10px 10px 0;">
          <strong>⚠️ Perhatian:</strong> Mood turun pada hari Senin, mungkin Monday Blues?
        </div>
        <div
          style="padding: 1rem; background: rgba(150, 206, 180, 0.1); border-left: 4px solid #96ceb4; border-radius: 0 10px 10px 0;">
          <strong>🎯 Saran:</strong> Coba aktivitas relaksasi di hari kerja untuk mood yang lebih baik.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Edit -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>✏️ Edit Cerita</h3>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editForm">
        <div class="input-group">
          <textarea id="editCatatan" placeholder="Edit cerita..." required maxlength="500"></textarea>
          <div class="character-count">
            <span id="editCharCount">0</span>/500 karakter
          </div>
        </div>
        <button type="submit" class="submit">💾 Simpan Perubahan</button>
      </form>
    </div>
  </div>
  <!-- Halaman Galeri -->
  <div id="page-gallery" class="page">
    <h2>🖼️ Galeri</h2>
    <p id="galleryCount" style="font-weight:bold;margin-bottom:1rem;">
      📸 Jumlah Gambar: 0
    </p>

    <!-- Form Upload -->
    <form id="uploadForm" style="margin-bottom:1rem;display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">

      <!-- Input file -->
      <input type="file" id="fileInput" accept="image/*" multiple required />

      <!-- Caption -->
      <input type="text" id="captionInput" placeholder="Tulis caption..." style="flex:1;padding:0.5rem;" />

      <!-- Dropdown kategori -->
      <select id="categoryInput" style="padding:0.5rem;border-radius:8px;">
        <option value="Umum">Umum</option>
        <option value="Liburan">Liburan</option>
        <option value="Keluarga">Keluarga</option>
        <option value="Meme">Meme</option>
      </select>

      <!-- Tombol Upload -->
      <button type="submit"
        style="padding:0.6rem 1rem;border:none;border-radius:10px;background:#4ecdc4;color:white;cursor:pointer;">
        📤 Upload
      </button>
    </form>

    <!-- Grid Galeri -->
    <div id="galleryGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
    </div>
  </div>


  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, arrayUnion, arrayRemove, increment, where, getDocs
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const supabaseUrl = "https://hnyingatwqsemhyhbwqb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhueWluZ2F0d3FzZW1oeWhid3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzU3NjIsImV4cCI6MjA3MTI1MTc2Mn0.sInRWG5g8APMXbi1nu6cLwDd4_g4TlsXAujQs_4biyk";
    const supabase = createClient(supabaseUrl, supabaseKey);


    const firebaseConfig = {
      apiKey: "AIzaSyD_sEU0Kn1Y15D0bfVw5gEvoJoU6slJUyA",
      authDomain: "keluhkesah-ec444.firebaseapp.com",
      projectId: "keluhkesah-ec444",
      storageBucket: "keluhkesah-ec444.firebasestorage.app",
      messagingSenderId: "96252446492",
      appId: "1:96252446492:web:1d1465382023793a189cd9",
      measurementId: "G-0N1ENCKMTN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allNotes = [];
    let currentEditId = null;
    let currentFilter = 'all';
    let currentTimeFilter = 'all';
    let currentCategoryFilter = 'all';
    let currentSort = 'newest';
    let selectedMood = null;
    let selectedCategory = null;
    let isAnonymous = false;
    let userId = 'user_' + Math.random().toString(36).substr(2, 9);
    let voiceRecording = false;
    let mediaRecorder = null;
    let recordingChunks = [];

    // Challenges array
    const dailyChallenges = [
      "Ceritakan satu hal kecil yang membuat kamu tersenyum hari ini!",
      "Apa yang paling kamu syukuri minggu ini?",
      "Bagikan pengalaman belajar terbaru kamu!",
      "Ceritakan tentang seseorang yang menginspirasi kamu!",
      "Apa rencana kamu untuk menjadi versi terbaik dari diri kamu?",
      "Bagikan momen kebahagiaan sederhana yang kamu alami!",
      "Ceritakan tentang pencapaian kecil yang membuatmu bangga!"
    ];

    // Mood prediction words
    const moodWords = {
      happy: ['senang', 'bahagia', 'gembira', 'excited', 'amazing', 'bagus', 'mantap', 'keren', 'suka', 'cinta'],
      sad: ['sedih', 'down', 'kecewa', 'galau', 'hancur', 'putus', 'gagal', 'susah', 'sulit'],
      angry: ['kesel', 'marah', 'benci', 'jengkel', 'sebel', 'dongkol', 'emosi', 'geram'],
      excited: ['excited', 'antusias', 'semangat', 'energik', 'bersemangat', 'wow', 'keren', 'luar biasa'],
      confused: ['bingung', 'confused', 'pusing', 'ragu', 'tidak tahu', 'gimana', 'kayak gimana'],
      grateful: ['syukur', 'terima kasih', 'grateful', 'berkat', 'alhamdulillah', 'thanks']
    };

    // DOM elements
    const noteForm = document.getElementById('noteForm');
    const editForm = document.getElementById('editForm');
    const notesList = document.getElementById('notesList');
    const popularNotes = document.getElementById('popularNotes');
    const emptyState = document.getElementById('emptyState');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const anonymousSwitch = document.getElementById('anonymousSwitch');
    const catatan = document.getElementById('catatan');
    const charCount = document.getElementById('charCount');
    const editCatatan = document.getElementById('editCatatan');
    const editCharCount = document.getElementById('editCharCount');
    const voiceBtn = document.getElementById('voiceBtn');
    const voiceStatus = document.getElementById('voiceStatus');
    const uploadForm = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileInput");
    const captionInput = document.getElementById("captionInput");
    const galleryGrid = document.getElementById("galleryGrid");

    // Initialize
    initializeEventListeners();
    loadNotes();
    loadWeather();
    generateDailyChallenge();
    generateMoodCalendar();

    const lastPage = localStorage.getItem('lastPage');
    if (lastPage && document.getElementById(lastPage)) {
      switchPage(lastPage);
    } else {
      switchPage('page-tulis');
    }

    function initializeEventListeners() {
      // Navigation
      document.getElementById('btn-tulis').addEventListener('click', () => switchPage('page-tulis'));
      document.getElementById('btn-daftar').addEventListener('click', () => switchPage('page-daftar'));
      document.getElementById('btn-trending').addEventListener('click', () => switchPage('page-trending'));
      document.getElementById('btn-analytics').addEventListener('click', () => switchPage('page-analytics'));
      document.getElementById('btn-mood-map').addEventListener('click', () => switchPage('page-mood-map'));
      document.getElementById("btn-gallery").addEventListener("click", () => switchPage("page-gallery"));


      // Upload gambar ke Supabase
      if (uploadForm) {
        uploadForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const files = fileInput.files;
          if (!files.length) return showNotification("Pilih gambar dulu!", "error");

          const caption = captionInput.value;
          const categoryInput = document.getElementById("categoryInput");
          const category = categoryInput ? categoryInput.value : "Umum";

          // Proses setiap file
          for (const file of files) {
            // Cek ukuran file
            const maxSize = 1.5 * 1024 * 1024; // 1.5 MB
            if (file.size > maxSize) {
              showNotification(`Ukuran ${file.name} terlalu besar (>1.5MB)`, "error");
              continue; // Skip file ini dan lanjutkan ke file berikutnya
            }

            const fileName = `${Date.now()}_${file.name}`;
            console.log("Uploading file:", fileName);

            // Upload ke Supabase Storage
            const { error: uploadError } = await supabase
              .storage.from("keluhkesah")
              .upload(fileName, file);

            if (uploadError) {
              console.error("Upload error:", uploadError);
              showNotification(`Upload gagal untuk ${file.name}: ${uploadError.message}`, "error");
              continue; 
            }

            // Ambil public URL
            const { data: publicUrl } = supabase.storage.from("keluhkesah").getPublicUrl(fileName);

            // Simpan metadata ke tabel gallery
            const { error: insertError } = await supabase.from("gallery").insert([
              { url: publicUrl.publicUrl, caption, category }
            ]);

            if (insertError) {
              console.error("Insert error:", insertError);
              showNotification(`Gagal simpan metadata ${file.name}`, "error");
              continue; 
            }
          }

          // Reset form
          captionInput.value = "";
          fileInput.value = "";
          if (categoryInput) categoryInput.value = "Umum";

          showNotification("✅ Semua gambar berhasil diupload!", "success");
          loadGallery();
        });
      }



      // Load galeri dari Supabase
      async function loadGallery() {
        const { data, error } = await supabase
          .from("gallery")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error(error);
          return;
        }

        // update jumlah gambar
        const galleryCount = document.getElementById("galleryCount");
        if (galleryCount) {
          galleryCount.textContent = `📸 Jumlah Gambar: ${data.length}`;
        }

        // render gambar
        galleryGrid.innerHTML = data
          .map(
            (item) => `
      <div class="gallery-item">
        <img 
  src="${item.url}" 
  alt="Gambar" 
  style="
    width:100%;
    height:auto;
    max-height:320px;      /* batasi tinggi biar grid rapi */
    object-fit:contain;    /* biar tidak crop */
    border-radius:10px;
    background:#fff;
    display:block;
    margin:0 auto;
  "
/>

        <div class="gallery-caption">
          <strong>📂 ${item.category}</strong><br>
          ${item.caption || ""}
        </div>
        <div class="gallery-actions">
          <button onclick="downloadImage('${item.url}')">⬇️ Download</button>
          <button onclick="deleteImage('${item.id}','${item.url}')">🗑️ Hapus</button>
        </div>
      </div>
    `
          )
          .join("");
      }


      // Download gambar
      window.downloadImage = async (url) => {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          const blobUrl = window.URL.createObjectURL(blob);

          // Ambil nama file asli dari url
          const fileName = url.split("/").pop();

          const a = document.createElement("a");
          a.href = blobUrl;
          a.download = fileName; // nama asli dari Supabase
          document.body.appendChild(a);
          a.click();
          a.remove();

          window.URL.revokeObjectURL(blobUrl);
        } catch (err) {
          console.error("Download gagal:", err);
          alert("Gagal download gambar!");
        }
      };


      // Hapus gambar
      window.deleteImage = async (id, url) => {
        if (!confirm("Yakin ingin menghapus gambar ini?")) return;

        // Hapus metadata dari tabel
        await supabase.from("gallery").delete().eq("id", id);

        // Hapus file dari storage
        const filePath = url.split("/").pop();
        await supabase.storage.from("gallery").remove([filePath]);

        showNotification("Gambar berhasil dihapus 🗑️");
        loadGallery();
      };
      // load awal
      loadGallery();


      // Forms
      noteForm.addEventListener('submit', handleSubmitNote);
      editForm.addEventListener('submit', handleEditNote);

      // Selectors
      document.querySelectorAll('.mood-option').forEach(option => {
        option.addEventListener('click', () => selectMood(option.dataset.mood));
      });

      document.querySelectorAll('.category-option').forEach(option => {
        option.addEventListener('click', () => selectCategory(option.dataset.category));
      });

      // Toggles and inputs
      anonymousSwitch.addEventListener('click', toggleAnonymous);
      catatan.addEventListener('input', () => {
        updateCharCount();
        predictMood();
      });
      editCatatan.addEventListener('input', updateEditCharCount);

      // Voice recording
      voiceBtn.addEventListener('click', toggleVoiceRecording);

      // Search and filters
      searchInput.addEventListener('input', filterNotes);
      sortSelect.addEventListener('change', (e) => {
        currentSort = e.target.value;
        filterNotes();
      });

      // Filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => setFilter(btn.dataset.filter));
      });

      document.querySelectorAll('.time-btn').forEach(btn => {
        if (btn.dataset.time) {
          btn.addEventListener('click', () => setTimeFilter(btn.dataset.time));
        }
        if (btn.dataset.categoryFilter) {
          btn.addEventListener('click', () => setCategoryFilter(btn.dataset.categoryFilter));
        }
      });

      // Modal
      document.addEventListener('click', (e) => {
        if (e.target === document.getElementById('editModal')) {
          closeEditModal();
        }
      });
    }

    function selectMood(mood) {
      document.querySelectorAll('.mood-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.querySelector(`[data-mood="${mood}"]`).classList.add('selected');
      selectedMood = mood;
    }

    function selectCategory(category) {
      document.querySelectorAll('.category-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.querySelector(`[data-category="${category}"]`).classList.add('selected');
      selectedCategory = category;
    }

    function toggleAnonymous() {
      isAnonymous = !isAnonymous;
      anonymousSwitch.classList.toggle('active', isAnonymous);
      const namaInput = document.getElementById('nama');
      namaInput.disabled = isAnonymous;
      if (isAnonymous) {
        namaInput.value = 'Anonim';
        namaInput.style.background = '#f5f5f5';
      } else {
        namaInput.value = '';
        namaInput.style.background = 'rgba(255,255,255,0.9)';
      }
    }

    function updateCharCount() {
      const count = catatan.value.length;
      charCount.textContent = count;
      charCount.parentElement.classList.toggle('warning', count > 450);
    }

    function updateEditCharCount() {
      const count = editCatatan.value.length;
      editCharCount.textContent = count;
      editCharCount.parentElement.classList.toggle('warning', count > 450);
    }

    function predictMood() {
      const text = catatan.value.toLowerCase();
      let scores = {};

      Object.keys(moodWords).forEach(mood => {
        scores[mood] = 0;
        moodWords[mood].forEach(word => {
          if (text.includes(word)) {
            scores[mood]++;
          }
        });
      });

      const predictedMood = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
      const maxScore = Math.max(...Object.values(scores));

      if (maxScore > 0) {
        const moodEmojis = {
          happy: '😊',
          sad: '😢',
          angry: '😠',
          excited: '🤩',
          confused: '😕',
          grateful: '🙏'
        };

        document.getElementById('predictedMood').textContent = moodEmojis[predictedMood];
        document.getElementById('moodPrediction').textContent = `Sepertinya kamu ${predictedMood}...`;
      } else {
        document.getElementById('predictedMood').textContent = '🤔';
        document.getElementById('moodPrediction').textContent = 'Tulis lebih banyak untuk prediksi yang akurat...';
      }
    }

    async function toggleVoiceRecording() {
      if (!voiceRecording) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          recordingChunks = [];

          mediaRecorder.ondataavailable = (event) => {
            recordingChunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const blob = new Blob(recordingChunks, { type: 'audio/wav' });
            // In a real app, you'd upload this to a speech-to-text service
            voiceStatus.textContent = 'Rekaman selesai! (Fitur speech-to-text akan datang)';
          };

          mediaRecorder.start();
          voiceRecording = true;
          voiceBtn.classList.add('recording');
          voiceStatus.textContent = 'Merekam... Klik lagi untuk berhenti';

        } catch (error) {
          showNotification('Browser tidak mendukung perekaman suara', 'error');
        }
      } else {
        mediaRecorder.stop();
        voiceRecording = false;
        voiceBtn.classList.remove('recording');
        voiceStatus.textContent = 'Klik untuk mulai merekam suara (opsional)';
      }
    }

    function generateDailyChallenge() {
      const today = new Date();
      const challengeIndex = today.getDate() % dailyChallenges.length;
      document.getElementById('dailyChallenge').textContent = dailyChallenges[challengeIndex];
    }

    function generateMoodCalendar() {
      const calendar = document.getElementById('moodCalendar');
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

      calendar.innerHTML = '';

      // Days of week header
      const daysOfWeek = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
      daysOfWeek.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.style.cssText = 'text-align: center; font-weight: bold; padding: 0.5rem;';
        dayHeader.textContent = day;
        calendar.appendChild(dayHeader);
      });

      // Empty cells for days before month start
      const startDay = (firstDay.getDay() + 6) % 7; // Convert to Monday = 0
      for (let i = 0; i < startDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.classList.add('mood-day');
        calendar.appendChild(emptyDay);
      }

      // Days of the month
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayElement = document.createElement('div');
        dayElement.classList.add('mood-day');
        dayElement.style.background = day === today.getDate() ? '#4ecdc4' : '#f0f0f0';
        dayElement.style.color = day === today.getDate() ? 'white' : '#333';

        // Simulate random moods for past days
        if (day < today.getDate()) {
          const moods = ['😊', '😢', '😠', '🤩', '😕', '🙏'];
          dayElement.textContent = moods[day % moods.length];
        } else if (day === today.getDate()) {
          dayElement.textContent = selectedMood ? getMoodEmoji(selectedMood) : day;
        } else {
          dayElement.textContent = day;
          dayElement.style.opacity = '0.5';
        }

        dayElement.addEventListener('click', () => {
          if (day <= today.getDate()) {
            showNotification(`Mood tanggal ${day}: ${dayElement.textContent}`);
          }
        });

        calendar.appendChild(dayElement);
      }
    }

    async function loadWeather() {
      const weatherWidget = document.getElementById('weatherWidget');
      const lat = 3.5952;   // Medan latitude
      const lon = 98.6722;  // Medan longitude
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,weather_code,wind_speed_10m&timezone=Asia%2FJakarta`;

      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const c = data.current;

        const { emoji, desc } = mapWeatherCode(c.weather_code);

        const updatedAt = new Date(c.time).toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });

        // Build compact widget UI
        weatherWidget.innerHTML = `
        <span>${emoji}</span>
        <span>${desc}</span>
        <span>${Math.round(c.temperature_2m)}°C</span>
        <span>💧${Math.round(c.relative_humidity_2m)}%</span>
        <span>💨${Math.round(c.wind_speed_10m)} km/j</span>
      `;
        weatherWidget.title = `Medan • Diperbarui ${updatedAt}`;
      } catch (err) {
        console.error("Gagal memuat cuaca:", err);
        weatherWidget.textContent = '🌤️ --°C';
      } finally {
        // refresh every 5 minutes
        setTimeout(loadWeather, 5 * 60 * 1000);
      }
    }

    function mapWeatherCode(code) {
      // Mapping Open-Meteo WMO weather codes ke emoji + deskripsi Bahasa
      const table = {
        0: { emoji: '☀️', desc: 'Cerah' },
        1: { emoji: '🌤️', desc: 'Sebagian cerah' },
        2: { emoji: '⛅', desc: 'Berawan sebagian' },
        3: { emoji: '☁️', desc: 'Berawan' },
        45: { emoji: '🌫️', desc: 'Berkabut' },
        48: { emoji: '🌫️', desc: 'Kabut membeku' },
        51: { emoji: '🌦️', desc: 'Gerimis ringan' },
        53: { emoji: '🌦️', desc: 'Gerimis sedang' },
        55: { emoji: '🌧️', desc: 'Gerimis lebat' },
        56: { emoji: '🌧️', desc: 'Gerimis beku ringan' },
        57: { emoji: '🌧️', desc: 'Gerimis beku lebat' },
        61: { emoji: '🌦️', desc: 'Hujan ringan' },
        63: { emoji: '🌧️', desc: 'Hujan sedang' },
        65: { emoji: '🌧️', desc: 'Hujan lebat' },
        66: { emoji: '🌧️', desc: 'Hujan beku ringan' },
        67: { emoji: '🌧️', desc: 'Hujan beku lebat' },
        71: { emoji: '❄️', desc: 'Salju ringan' },
        73: { emoji: '❄️', desc: 'Salju sedang' },
        75: { emoji: '❄️', desc: 'Salju lebat' },
        77: { emoji: '🌨️', desc: 'Butiran salju' },
        80: { emoji: '🌦️', desc: 'Hujan lokal ringan' },
        81: { emoji: '🌧️', desc: 'Hujan lokal sedang' },
        82: { emoji: '⛈️', desc: 'Hujan lokal lebat' },
        85: { emoji: '🌨️', desc: 'Hujan salju ringan' },
        86: { emoji: '🌨️', desc: 'Hujan salju lebat' },
        95: { emoji: '⛈️', desc: 'Badai petir' },
        96: { emoji: '⛈️', desc: 'Badai petir + es kecil' },
        99: { emoji: '⛈️', desc: 'Badai petir + es besar' },
      };
      return table[code] || { emoji: '🌤️', desc: 'Cuaca' };
    }

    // jalankan pas pertama kali load halaman
    loadWeather();

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      document.querySelector('.theme-toggle').textContent = isDark ? '☀️' : '🌙';
    }

    // Load saved theme
    if (localStorage.getItem('darkMode') === 'true') {
      toggleTheme();
    }

    // Make toggleTheme global
    window.toggleTheme = toggleTheme;

    async function handleSubmitNote(e) {
      e.preventDefault();

      const nama = isAnonymous ? 'Anonim' : document.getElementById('nama').value.trim();
      const catatanText = catatan.value.trim();

      if ((!isAnonymous && !nama) || !catatanText || !selectedMood || !selectedCategory) {
        showNotification('Harap lengkapi semua field!', 'error');
        return;
      }

      if (catatanText.length > 500) {
        showNotification('Cerita terlalu panjang! Maksimal 500 karakter.', 'error');
        return;
      }

      try {
        await addDoc(collection(db, "notes"), {
          nama,
          catatan: catatanText,
          mood: selectedMood,
          category: selectedCategory,
          waktu: serverTimestamp(),
          likes: [],
          hearts: [],
          supports: [],
          comments: [],
          totalReactions: 0,
          userId: isAnonymous ? 'anonymous' : userId,
          isAnonymous
        });

        noteForm.reset();
        selectedMood = null;
        selectedCategory = null;
        document.querySelectorAll('.mood-option').forEach(option => {
          option.classList.remove('selected');
        });
        document.querySelectorAll('.category-option').forEach(option => {
          option.classList.remove('selected');
        });
        updateCharCount();

        // Update daily streak
        updateDailyStreak();

        showNotification('Cerita berhasil dikirim! 🎉');
        switchPage('page-daftar');
      } catch (error) {
        console.error("Error adding document: ", error);
        showNotification('Terjadi kesalahan saat mengirim cerita.', 'error');
      }
    }

    async function handleEditNote(e) {
      e.preventDefault();

      const newText = editCatatan.value.trim();

      if (!newText) {
        showNotification('Cerita tidak boleh kosong!', 'error');
        return;
      }

      if (newText.length > 500) {
        showNotification('Cerita terlalu panjang! Maksimal 500 karakter.', 'error');
        return;
      }

      try {
        await updateDoc(doc(db, "notes", currentEditId), {
          catatan: newText,
          lastEdited: serverTimestamp()
        });

        showNotification('Cerita berhasil diupdate! ✨');
        closeEditModal();
      } catch (error) {
        console.error("Error updating document: ", error);
        showNotification('Terjadi kesalahan saat mengupdate cerita.', 'error');
      }
    }

    function openEditModal(id, currentText) {
      currentEditId = id;
      editCatatan.value = currentText;
      updateEditCharCount();
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      currentEditId = null;
      editCatatan.value = '';
    }

    window.closeEditModal = closeEditModal;

    async function toggleReaction(noteId, reactionType) {
      try {
        const noteRef = doc(db, "notes", noteId);
        const note = allNotes.find(n => n.id === noteId);

        if (!note) return;

        const userReacted = note[reactionType] && note[reactionType].includes(userId);

        if (userReacted) {
          await updateDoc(noteRef, {
            [reactionType]: arrayRemove(userId),
            totalReactions: increment(-1)
          });
        } else {
          await updateDoc(noteRef, {
            [reactionType]: arrayUnion(userId),
            totalReactions: increment(1)
          });
        }
      } catch (error) {
        console.error("Error toggling reaction: ", error);
        showNotification('Terjadi kesalahan saat memberikan reaksi.', 'error');
      }
    }

    async function addComment(noteId, comment) {
      if (!comment.trim()) return;

      try {
        const noteRef = doc(db, "notes", noteId);
        const commentData = {
          text: comment,
          author: isAnonymous ? 'Anonim' : document.getElementById('nama').value || 'Anonymous',
          userId: userId,
          timestamp: new Date().toISOString()
        };

        await updateDoc(noteRef, {
          comments: arrayUnion(commentData)
        });

        showNotification('Komentar berhasil ditambahkan! 💬');
      } catch (error) {
        console.error("Error adding comment: ", error);
        showNotification('Terjadi kesalahan saat menambahkan komentar.', 'error');
      }
    }

    async function deleteNote(id) {
      if (confirm("Yakin ingin menghapus cerita ini?")) {
        try {
          await deleteDoc(doc(db, "notes", id));
          showNotification('Cerita berhasil dihapus! 🗑️');
        } catch (error) {
          console.error("Error deleting document: ", error);
          showNotification('Terjadi kesalahan saat menghapus cerita.', 'error');
        }
      }
    }

    function shareNote(noteId) {
      const url = `${window.location.origin}${window.location.pathname}#note-${noteId}`;

      if (navigator.share) {
        navigator.share({
          title: 'Keluh Kesah',
          text: 'Lihat cerita menarik ini!',
          url: url
        });
      } else {
        navigator.clipboard.writeText(url).then(() => {
          showNotification('Link berhasil disalin! 🔗');
        });
      }
    }

    function updateDailyStreak() {
      const today = new Date().toDateString();
      const lastPost = localStorage.getItem('lastPostDate');
      let streak = parseInt(localStorage.getItem('dailyStreak') || '0');

      if (lastPost !== today) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);

        if (lastPost === yesterday.toDateString()) {
          streak++;
        } else if (lastPost !== today) {
          streak = 1;
        }

        localStorage.setItem('dailyStreak', streak.toString());
        localStorage.setItem('lastPostDate', today);
        document.getElementById('dailyStreak').textContent = streak;
      }
    }

    function formatTime(timestamp) {
      if (!timestamp) return "Menunggu waktu...";

      const date = timestamp.toDate();
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);

      if (diffInSeconds < 60) {
        return "Baru saja";
      } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} menit yang lalu`;
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} jam yang lalu`;
      } else if (diffInSeconds < 604800) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} hari yang lalu`;
      } else {
        const options = {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        };
        return date.toLocaleDateString('id-ID', options);
      }
    }

    function getMoodBadgeClass(mood) {
      return `mood-${mood}`;
    }

    function getMoodEmoji(mood) {
      const emojis = {
        happy: '😊',
        sad: '😢',
        angry: '😠',
        excited: '🤩',
        confused: '😕',
        grateful: '🙏'
      };
      return emojis[mood] || '😐';
    }

    function getCategoryEmoji(category) {
      const emojis = {
        personal: '👤',
        work: '💼',
        family: '👨‍👩‍👧‍👦',
        love: '💕',
        health: '🏥',
        education: '🎓'
      };
      return emojis[category] || '📝';
    }

    function createNoteElement(docSnap) {
      const data = docSnap.data();
      const waktuFormatted = formatTime(data.waktu);
      const li = document.createElement("li");
      li.id = `note-${docSnap.id}`;

      const isOwner = data.userId === userId;
      const authorName = data.isAnonymous ? '👤 Anonim' : `👤 ${data.nama}`;

      const likesCount = data.likes ? data.likes.length : 0;
      const heartsCount = data.hearts ? data.hearts.length : 0;
      const supportsCount = data.supports ? data.supports.length : 0;
      const commentsCount = data.comments ? data.comments.length : 0;

      const userLiked = data.likes ? data.likes.includes(userId) : false;
      const userHearted = data.hearts ? data.hearts.includes(userId) : false;
      const userSupported = data.supports ? data.supports.includes(userId) : false;

      li.innerHTML = `
        <div class="note-header">
          <div class="note-info">
            <div class="author-info">
              <span class="author-name">${authorName}</span>
              <span class="mood-badge ${getMoodBadgeClass(data.mood)}">${getMoodEmoji(data.mood)} ${data.mood}</span>
              ${data.category ? `<span class="category-badge">${getCategoryEmoji(data.category)} ${data.category}</span>` : ''}
            </div>
          </div>
        </div>
        <div class="note-text">${data.catatan}</div>
        
        <div class="comments-section">
          <div class="comments-toggle" onclick="toggleComments('${docSnap.id}')">
            💬 ${commentsCount} komentar ${commentsCount > 0 ? '(klik untuk lihat)' : ''}
          </div>
          <div class="comments-list" id="comments-${docSnap.id}" style="display: none;"></div>
          <div class="comment-form">
            <input type="text" class="comment-input" id="comment-input-${docSnap.id}" placeholder="Tulis komentar...">
            <button class="comment-btn" onclick="submitComment('${docSnap.id}')">Kirim</button>
          </div>
        </div>
        
        <div class="note-footer">
          <div class="timestamp">🕒 ${waktuFormatted}</div>
          <div class="reactions-section">
            <button class="reaction-btn ${userLiked ? 'active' : ''}" onclick="toggleReaction('${docSnap.id}', 'likes')">
              👍 ${likesCount}
            </button>
            <button class="reaction-btn ${userHearted ? 'active' : ''}" onclick="toggleReaction('${docSnap.id}', 'hearts')">
              ❤️ ${heartsCount}
            </button>
            <button class="reaction-btn ${userSupported ? 'active' : ''}" onclick="toggleReaction('${docSnap.id}', 'supports')">
              🤗 ${supportsCount}
            </button>
          </div>
          <div class="actions-section">
            <button class="action-btn edit-btn" onclick="openEditModal('${docSnap.id}', '${data.catatan.replace(/'/g, "\\'")}')" title="Edit">
              ✏️ Edit
            </button>
            <button class="action-btn share-btn" onclick="shareNote('${docSnap.id}')" title="Bagikan">
              🔗 Bagikan
            </button>
            <button class="action-btn delete-btn" onclick="deleteNote('${docSnap.id}')" title="Hapus">
              🗑️ Hapus
            </button>
          </div>
        </div>
      `;

      return li;
    }

    function toggleComments(noteId) {
      const commentsList = document.getElementById(`comments-${noteId}`);
      const isVisible = commentsList.style.display !== 'none';

      if (isVisible) {
        commentsList.style.display = 'none';
      } else {
        const note = allNotes.find(n => n.id === noteId);
        if (note && note.comments) {
          commentsList.innerHTML = note.comments.map(comment => `
            <div class="comment">
              <strong>${comment.author}:</strong> ${comment.text}
              <div style="font-size: 0.8em; color: #666; margin-top: 0.2rem;">
                ${new Date(comment.timestamp).toLocaleString('id-ID')}
              </div>
            </div>
          `).join('');
        }
        commentsList.style.display = 'block';
      }
    }

    function submitComment(noteId) {
      const input = document.getElementById(`comment-input-${noteId}`);
      const comment = input.value.trim();

      if (comment) {
        addComment(noteId, comment);
        input.value = '';
      }
    }

    function loadNotes() {
      const q = query(collection(db, "notes"), orderBy("waktu", "desc"));
      onSnapshot(q, (snapshot) => {
        allNotes = [];
        snapshot.forEach((docSnap) => {
          allNotes.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });

        updateStats();
        filterNotes();
        updatePopularNotes();
        updateAnalytics();
        generateWordCloud();
      });
    }

    function filterNotes() {
      let filteredNotes = [...allNotes];

      // Filter by search
      const searchTerm = searchInput.value.toLowerCase().trim();
      if (searchTerm) {
        filteredNotes = filteredNotes.filter(note =>
          note.catatan.toLowerCase().includes(searchTerm) ||
          note.nama.toLowerCase().includes(searchTerm) ||
          (note.category && note.category.toLowerCase().includes(searchTerm))
        );
      }

      // Filter by mood
      if (currentFilter !== 'all') {
        filteredNotes = filteredNotes.filter(note => note.mood === currentFilter);
      }

      // Filter by time
      if (currentTimeFilter !== 'all') {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

        filteredNotes = filteredNotes.filter(note => {
          if (!note.waktu) return false;
          const noteDate = note.waktu.toDate();

          switch (currentTimeFilter) {
            case 'today':
              return noteDate >= today;
            case 'week':
              return noteDate >= weekAgo;
            case 'month':
              return noteDate >= monthAgo;
            default:
              return true;
          }
        });
      }

      // Filter by category
      if (currentCategoryFilter !== 'all') {
        filteredNotes = filteredNotes.filter(note => note.category === currentCategoryFilter);
      }

      // Sort
      filteredNotes.sort((a, b) => {
        switch (currentSort) {
          case 'oldest':
            return (a.waktu?.toDate() || 0) - (b.waktu?.toDate() || 0);
          case 'popular':
            return (b.totalReactions || 0) - (a.totalReactions || 0);
          case 'random':
            return Math.random() - 0.5;
          default: // newest
            return (b.waktu?.toDate() || 0) - (a.waktu?.toDate() || 0);
        }
      });

      displayNotes(filteredNotes);
    }

    function displayNotes(notes) {
      notesList.innerHTML = "";

      if (notes.length === 0) {
        emptyState.style.display = "block";
        return;
      }

      emptyState.style.display = "none";

      notes.forEach((note) => {
        const li = createNoteElement({ id: note.id, data: () => note });
        notesList.appendChild(li);
      });
    }

    function updatePopularNotes() {
      const popular = [...allNotes]
        .sort((a, b) => (b.totalReactions || 0) - (a.totalReactions || 0))
        .slice(0, 5);

      popularNotes.innerHTML = "";

      if (popular.length === 0) {
        popularNotes.innerHTML = '<li style="text-align: center; padding: 2rem; color: #666;">Belum ada cerita populer</li>';
        return;
      }

      popular.forEach((note) => {
        const li = createNoteElement({ id: note.id, data: () => note });
        popularNotes.appendChild(li);
      });
    }

    function generateWordCloud() {
      const wordFreq = {};
      const commonWords = ['dan', 'yang', 'di', 'ke', 'dari', 'untuk', 'dengan', 'pada', 'adalah', 'ini', 'itu', 'tidak', 'juga', 'atau', 'tapi', 'karena', 'saya', 'aku', 'kamu', 'dia'];

      allNotes.forEach(note => {
        const words = note.catatan.toLowerCase().split(/\s+/);
        words.forEach(word => {
          word = word.replace(/[^\w\s]/g, '');
          if (word.length > 3 && !commonWords.includes(word)) {
            wordFreq[word] = (wordFreq[word] || 0) + 1;
          }
        });
      });

      const sortedWords = Object.entries(wordFreq)
        .sort(([, a], [, b]) => b - a)
        .slice(0, 15);

      const wordCloud = document.getElementById('wordCloud');
      wordCloud.innerHTML = sortedWords.map(([word, freq]) => {
        const size = Math.min(3, 1 + (freq / Math.max(...Object.values(wordFreq))) * 2);
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#ff7675', '#74b9ff'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        return `<span style="font-size: ${size}rem; color: ${color}; margin: 0.5rem;">${word}</span>`;
      }).join(' ');
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
      filterNotes();
    }

    function setTimeFilter(timeFilter) {
      currentTimeFilter = timeFilter;
      document.querySelectorAll('[data-time]').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-time="${timeFilter}"]`).classList.add('active');
      filterNotes();
    }

    function setCategoryFilter(categoryFilter) {
      currentCategoryFilter = categoryFilter;
      document.querySelectorAll('[data-category-filter]').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-category-filter="${categoryFilter}"]`).classList.add('active');
      filterNotes();
    }

    function updateStats() {
      const totalPosts = allNotes.length;
      const totalLikes = allNotes.reduce((sum, note) => sum + (note.totalReactions || 0), 0);
      const uniqueUsers = new Set(allNotes.map(note => note.userId)).size;
      const dailyStreak = parseInt(localStorage.getItem('dailyStreak') || '0');

      document.getElementById('totalPosts').textContent = totalPosts;
      document.getElementById('totalLikes').textContent = totalLikes;
      document.getElementById('activeUsers').textContent = uniqueUsers;
      document.getElementById('dailyStreak').textContent = dailyStreak;
    }

    function updateAnalytics() {
      const totalPosts = allNotes.length;
      const totalReactions = allNotes.reduce((sum, note) => sum + (note.totalReactions || 0), 0);
      const avgReactions = totalPosts > 0 ? Math.round(totalReactions / totalPosts * 10) / 10 : 0;

      // Count moods
      const moodCounts = {};
      allNotes.forEach(note => {
        moodCounts[note.mood] = (moodCounts[note.mood] || 0) + 1;
      });

      const topMood = Object.keys(moodCounts).reduce((a, b) =>
        moodCounts[a] > moodCounts[b] ? a : b, 'happy');

      // Calculate most active hour
      const hourCounts = {};
      allNotes.forEach(note => {
        if (note.waktu) {
          const hour = note.waktu.toDate().getHours();
          hourCounts[hour] = (hourCounts[hour] || 0) + 1;
        }
      });

      const mostActiveHour = Object.keys(hourCounts).reduce((a, b) =>
        hourCounts[a] > hourCounts[b] ? a : b, '18');

      document.getElementById('totalPostsAnalytics').textContent = totalPosts;
      document.getElementById('totalReactionsAnalytics').textContent = totalReactions;
      document.getElementById('avgReactionsAnalytics').textContent = avgReactions;
      document.getElementById('topMoodAnalytics').textContent = getMoodEmoji(topMood);
      document.getElementById('activeHoursAnalytics').textContent = `${mostActiveHour}:00`;
      document.getElementById('longestStreakAnalytics').textContent = localStorage.getItem('longestStreak') || '0';

      // Update mood chart
      const moodChart = document.getElementById('moodChart');
      moodChart.innerHTML = '';

      Object.entries(moodCounts).forEach(([mood, count]) => {
        const percentage = totalPosts > 0 ? Math.round(count / totalPosts * 100) : 0;
        const bar = document.createElement('div');
        bar.style.cssText = `
          background: linear-gradient(45deg, #4ecdc4, #45b7d1);
          color: white;
          padding: 1rem;
          border-radius: 10px;
          text-align: center;
          min-width: 120px;
        `;
        bar.innerHTML = `
          <div style="font-size: 1.5rem;">${getMoodEmoji(mood)}</div>
          <div style="font-weight: bold;">${count}</div>
          <div style="font-size: 0.8rem;">${percentage}%</div>
        `;
        moodChart.appendChild(bar);
      });

      // Update activity chart
      const activityChart = document.getElementById('activityChart');
      const dayNames = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];

      // Skip the headers and update activity bars
      const dayCounts = [0, 0, 0, 0, 0, 0, 0];
      allNotes.forEach(note => {
        if (note.waktu) {
          const dayOfWeek = (note.waktu.toDate().getDay() + 6) % 7; // Convert to Monday = 0
          dayCounts[dayOfWeek]++;
        }
      });

      const maxCount = Math.max(...dayCounts) || 1;

      dayCounts.forEach((count, index) => {
        const intensity = count / maxCount;
        const activityBar = document.createElement('div');
        activityBar.style.cssText = `
          background: rgba(78, 205, 196, ${0.2 + intensity * 0.8});
          padding: 1rem;
          border-radius: 5px;
          text-align: center;
          font-weight: bold;
          color: ${intensity > 0.5 ? 'white' : '#333'};
        `;
        activityBar.textContent = count;
        activityChart.appendChild(activityBar);
      });
    }

    function switchPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');

      document.querySelectorAll('nav button').forEach(btn => {
        btn.classList.remove('active');
      });

      if (pageId === 'page-tulis') document.getElementById('btn-tulis').classList.add('active');
      else if (pageId === 'page-daftar') document.getElementById('btn-daftar').classList.add('active');
      else if (pageId === 'page-trending') document.getElementById('btn-trending').classList.add('active');
      else if (pageId === 'page-analytics') document.getElementById('btn-analytics').classList.add('active');
      else if (pageId === 'page-mood-map') document.getElementById('btn-mood-map').classList.add('active');
      else if (pageId === 'page-gallery') document.getElementById('btn-gallery').classList.add('active');

      localStorage.setItem('lastPage', pageId);

      // Update mood calendar when switching to mood map page
      if (pageId === 'page-mood-map') {
        generateMoodCalendar();
      }
    }

    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Make functions global for onclick handlers
    window.toggleReaction = toggleReaction;
    window.deleteNote = deleteNote;
    window.shareNote = shareNote;
    window.openEditModal = openEditModal;
    window.toggleComments = toggleComments;
    window.submitComment = submitComment;

    // Auto-refresh features
    setInterval(() => {
      // Update relative timestamps
      if (document.getElementById('page-daftar').classList.contains('active') ||
        document.getElementById('page-trending').classList.contains('active')) {
        document.querySelectorAll('.timestamp').forEach(timestamp => {
          // Timestamps will be updated on next Firebase update
        });
      }

      // Update daily challenge
      generateDailyChallenge();

      // Update weather
      loadWeather();
    }, 60000);

    // Handle deep linking to specific notes
    if (window.location.hash.startsWith('#note-')) {
      const noteId = window.location.hash.substring(6);
      setTimeout(() => {
        const noteElement = document.getElementById(`note-${noteId}`);
        if (noteElement) {
          switchPage('page-daftar');
          noteElement.scrollIntoView({ behavior: 'smooth' });
          noteElement.style.animation = 'pulse 2s ease-in-out';
        }
      }, 1000);
    }

    // Initialize streak counter
    const currentStreak = parseInt(localStorage.getItem('dailyStreak') || '0');
    const longestStreak = parseInt(localStorage.getItem('longestStreak') || '0');
    if (currentStreak > longestStreak) {
      localStorage.setItem('longestStreak', currentStreak.toString());
    }
  </script>

  <style>
    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.02);
        box-shadow: 0 20px 50px rgba(78, 205, 196, 0.3);
      }
    }
  </style>
</body>

</html>